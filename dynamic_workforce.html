<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRMMF Dynamic Workforce</title>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;600;700&family=Hind:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-navy: #011E3D;
            --brand-gold: #E8B373;
            --bg-main: #0b1f35;
            --bg-card: #0f2a4d;
            --text-main: #F5F5F5;
            --text-sub: #c6d3e6;
            --border-color: rgba(42, 77, 118, 0.7);
            --shadow: rgba(0, 0, 0, 0.4);
            --success: #2ecc71;
        }
        [data-theme="light"] {
            --bg-main: #f4f7f6;
            --bg-card: #ffffff;
            --text-main: #011E3D;
            --text-sub: #5d6b7a;
            --border-color: rgba(223, 230, 238, 0.9);
            --shadow: rgba(0,0,0,0.08);
        }
        body {
            margin: 0;
            font-family: "Hind", sans-serif;
            background: radial-gradient(circle at top left, #123a63, #0b1f35 50%, #0a1b2c);
            color: var(--text-main);
        }
        [data-theme="light"] body {
            background: radial-gradient(circle at top left, #ffffff, #f4f7f6 45%, #eef2f6);
        }
        header {
            background: rgba(1, 30, 61, 0.95);
            padding: 12px 26px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .logo {
            font-family: "League Spartan", sans-serif;
            font-weight: 700;
            color: var(--brand-gold);
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo img {
            height: 34px;
            max-width: 180px;
            object-fit: contain;
            display: none;
        }
        .nav-link {
            background: transparent;
            color: var(--text-sub);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 8px;
        }
        .nav-link:hover {
            border-color: var(--brand-gold);
            color: var(--brand-gold);
        }
        .nav-link.active {
            background: var(--brand-gold);
            color: var(--brand-navy);
            border-color: var(--brand-gold);
        }
        .nav-group { display: flex; align-items: center; gap: 8px; }
        .nav-divider { width: 1px; height: 26px; background: var(--border-color); margin: 0 8px; }
        .nav-dropdown { position: relative; }
        .nav-menu {
            position: absolute; right: 0; top: 42px; background: var(--bg-card);
            border: 1px solid var(--border-color); border-radius: 10px; min-width: 180px;
            box-shadow: 0 10px 24px var(--shadow); display: none; z-index: 3000;
        }
        .nav-menu button {
            width: 100%; text-align: left; background: transparent; border: none; color: var(--text-main);
            padding: 10px 12px; cursor: pointer; font-weight: 600;
        }
        .nav-menu button:hover { background: rgba(232, 179, 115, 0.12); color: var(--brand-gold); }
        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            padding: 20px 26px 40px;
        }
        .shell {
            display: flex;
            min-height: calc(100vh - 64px);
        }
        .left-nav {
            width: 210px;
            padding: 16px 10px;
            background: rgba(1, 22, 46, 0.95);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .left-nav .side-btn {
            text-decoration: none;
            color: var(--text-main);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 600;
            text-align: left;
        }
        .left-nav .side-btn:hover {
            border-color: var(--brand-gold);
            color: var(--brand-gold);
        }
        .left-nav .side-btn.active {
            border-color: var(--brand-gold);
            color: var(--brand-navy);
            background: var(--brand-gold);
        }
        .content-wrap {
            flex: 1;
        }
        .app-footer {
            margin: 30px 40px 50px;
            padding: 18px 24px;
            border-top: 1px solid var(--border-color);
            color: var(--text-sub);
            font-size: 0.85rem;
            text-align: center;
        }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 10px 30px var(--shadow);
        }
        .section-title {
            font-family: "League Spartan", sans-serif;
            font-weight: 700;
            color: var(--brand-gold);
            margin: 10px 0 20px;
            font-size: 1.2em;
        }
        .question-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 14px;
            background: rgba(8, 25, 43, 0.6);
        }
        .question-title {
            font-family: "League Spartan", sans-serif;
            font-weight: 600;
            margin: 0 0 6px;
        }
        .question-text {
            color: var(--text-sub);
            margin: 0 0 12px;
        }
        .question-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        select, input[type="text"] {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: #0B2136;
            color: var(--text-main);
            flex: 1;
        }
        .btn {
            background: var(--brand-gold);
            color: var(--brand-navy);
            border: none;
            border-radius: 8px;
            padding: 9px 14px;
            font-weight: 700;
            cursor: pointer;
        }
        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--brand-gold);
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--brand-gold);
            color: var(--brand-gold);
        }
        .status {
            font-size: 0.85em;
            color: var(--success);
        }
        .muted {
            color: var(--text-sub);
            font-size: 0.9em;
        }
        .analysis-output {
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            color: #CFE3F0;
        }
        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
            header { padding: 12px 20px; }
        }
    </style>
</head>
<body>
<header>
    <div class="logo" id="brand-header">
        <img id="brand-logo" alt="IRMMF logo">
        <span id="brand-text">IRMMF Dynamic Workforce</span>
    </div>
    <div class="nav-group">
        <div class="nav-dropdown">
            <button class="nav-link" onclick="toggleNavMenu('maturity-menu')">Maturity Assessment ‚ñæ</button>
            <div id="maturity-menu" class="nav-menu">
                <button onclick="goBack('results')">Dashboard</button>
                <button onclick="goBack('dashboard')">Assessment</button>
                <button onclick="goBack('risks')">Risks</button>
                <button onclick="goBack('review')">Review</button>
            </div>
        </div>
        <div class="nav-dropdown">
            <button class="nav-link active" onclick="toggleNavMenu('workforce-menu')">Workforce ‚ñæ</button>
            <div id="workforce-menu" class="nav-menu">
                <button onclick="scrollToSection('dwf-setup')">Assessment</button>
                <button onclick="scrollToSection('dwf-analysis')">Analysis</button>
            </div>
        </div>
        <button class="nav-link" onclick="goSettings()">Settings</button>
        <button class="nav-link" onclick="logoutUser()">Logout</button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode"><span id="theme-icon">‚òÄÔ∏è</span></button>
    </div>
</header>

<div class="shell">
    <nav class="left-nav">
        <a class="side-btn" href="index.html">Command Center</a>
        <a class="side-btn" href="assessment.html#dashboard">Assessment Hub</a>
        <a class="side-btn" href="settings.html">Settings</a>
        <details open>
            <summary class="side-btn">Assessment Views ‚ñæ</summary>
            <div style="display:flex; flex-direction:column; gap:8px; margin:8px 0 0 8px;">
                <a class="side-btn" href="assessment.html#dashboard">Assessment Dashboard</a>
                <a class="side-btn" href="assessment.html#intake">Intake</a>
                <a class="side-btn" href="assessment.html#assessment">Assessment</a>
                <a class="side-btn" href="assessment.html#results">Results</a>
                <a class="side-btn" href="assessment.html#risks">Risks</a>
                <a class="side-btn" href="assessment.html#review">Review</a>
            </div>
        </details>
        <details open>
            <summary class="side-btn">Workforce ‚ñæ</summary>
            <div style="display:flex; flex-direction:column; gap:8px; margin:8px 0 0 8px;">
                <a class="side-btn" href="dynamic_workforce.html">DWF Overview</a>
            </div>
        </details>
    </nav>
    <div class="content-wrap">
        <div class="layout">
    <div class="card" id="dwf-setup">
        <div class="section-title">Assessment Setup</div>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:20px;">
            <input type="text" id="aid-input" placeholder="Assessment ID (IRMMF-...)" />
            <button class="btn" onclick="registerAssessment()">Register</button>
        </div>
        <div id="register-status" class="muted">No assessment loaded.</div>
        <div class="section-title" style="margin-top:30px;">Questions</div>
        <div id="questions-container"></div>
    </div>

    <div class="card" id="dwf-analysis">
        <div class="section-title">Analysis</div>
        <button class="btn" onclick="runAnalysis()" style="margin-bottom:12px;">Run Analysis</button>
        <div id="analysis-output" class="analysis-output">Run analysis to view DWF scores.</div>
    </div>
        </div>
        <footer class="app-footer">¬© 2026 Belfort Advisory. All rights reserved.</footer>
    </div>
</div>

<script>
    const API_BASE = "http://127.0.0.1:8000/api/v1";
    const BRAND_LOGO_KEY = "irmmf_logo_data";
    let assessmentId = "";
    let questions = [];
    let optionMap = {};

    function initTheme() {
        const stored = localStorage.getItem("theme");
        if (stored) {
            document.documentElement.setAttribute("data-theme", stored);
            updateThemeIcon(stored);
        }
    }
    window.addEventListener("storage", (event) => {
        if (event.key !== "theme") return;
        const theme = event.newValue || "dark";
        document.documentElement.setAttribute("data-theme", theme);
        updateThemeIcon(theme);
    });

    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-theme") || "dark";
        const next = current === "light" ? "dark" : "light";
        html.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
        updateThemeIcon(next);
    }

    function updateThemeIcon(theme) {
        const icon = document.getElementById("theme-icon");
        if (icon) icon.textContent = theme === "light" ? "üåô" : "‚òÄÔ∏è";
    }

    function applyBranding() {
        const logoData = localStorage.getItem(BRAND_LOGO_KEY);
        const logoImg = document.getElementById("brand-logo");
        const logoText = document.getElementById("brand-text");
        if (!logoImg || !logoText) return;
        if (logoData) {
            logoImg.src = logoData;
            logoImg.style.display = "block";
            logoText.style.display = "none";
        } else {
            logoImg.removeAttribute("src");
            logoImg.style.display = "none";
            logoText.style.display = "block";
        }
    }

    function logoutUser() {
        localStorage.removeItem("irmmf_user");
        window.location.href = "index.html";
    }

    function goSettings() {
        window.location.href = "settings.html";
    }

    function getAidFromHash() {
        const raw = (location.hash || "").replace("#", "");
        if (!raw) return "";
        if (raw.startsWith("aid=")) {
            return decodeURIComponent(raw.replace("aid=", ""));
        }
        return "";
    }

    function setAidHash(aid) {
        if (!aid) return;
        const next = `#aid=${encodeURIComponent(aid)}`;
        if (location.hash !== next) {
            history.replaceState(null, "", next);
        }
    }

    function goBack(tab) {
        const aid = assessmentId || localStorage.getItem("assessment_id") || "";
        const safeTab = tab || "results";
        const target = aid ? `assessment.html#${safeTab}&aid=${encodeURIComponent(aid)}` : "assessment.html";
        window.location.href = target;
    }

    function toggleNavMenu(menuId) {
        const menu = document.getElementById(menuId);
        if (!menu) return;
        document.querySelectorAll('.nav-menu').forEach(m => {
            if (m !== menu) m.style.display = 'none';
        });
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function scrollToSection(id) {
        const el = document.getElementById(id);
        if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "start" });
        }
        document.querySelectorAll('.nav-menu').forEach(m => m.style.display = 'none');
    }

    document.addEventListener('click', (e) => {
        const dropdowns = document.querySelectorAll('.nav-dropdown');
        let inside = false;
        dropdowns.forEach(d => { if (d.contains(e.target)) inside = true; });
        if (!inside) {
            document.querySelectorAll('.nav-menu').forEach(m => m.style.display = 'none');
        }
    });

    applyBranding();
    initTheme();

    function registerAssessment() {
        const input = document.getElementById("aid-input");
        const aid = (input.value || "").trim();
        if (!aid) return;
        assessmentId = aid;
        localStorage.setItem("assessment_id", aid);
        setAidHash(aid);
        fetch(`${API_BASE}/dwf/assessment/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ assessment_id: aid })
        }).then(() => {
            document.getElementById("register-status").textContent = `Active assessment: ${aid}`;
            loadQuestions();
        }).catch(() => {
            document.getElementById("register-status").textContent = "Failed to register assessment.";
        });
    }

    function loadQuestions() {
        fetch(`${API_BASE}/dwf/questions/all`)
            .then(r => r.json())
            .then(data => {
                questions = data || [];
                optionMap = {};
                questions.forEach(q => {
                    optionMap[q.q_id] = q.options || [];
                });
                renderQuestions();
            })
            .catch(() => {
                document.getElementById("questions-container").innerHTML = "<div class='muted'>Failed to load questions.</div>";
            });
    }

    function renderQuestions() {
        const container = document.getElementById("questions-container");
        if (!questions.length) {
            container.innerHTML = "<div class='muted'>No DWF questions loaded.</div>";
            return;
        }
        const groups = {};
        questions.forEach(q => {
            const section = q.section || "General";
            if (!groups[section]) groups[section] = [];
            groups[section].push(q);
        });
        container.innerHTML = "";
        Object.keys(groups).forEach(section => {
            const sectionBlock = document.createElement("div");
            sectionBlock.innerHTML = `<div class="section-title">${section}</div>`;
            groups[section].forEach(q => {
                const card = document.createElement("div");
                card.className = "question-card";
                const options = optionMap[q.q_id] || [];
                const selectHtml = options.map(o => `<option value="${o.a_id}" data-score="${o.base_score}">${o.answer_text}</option>`).join("");
                card.innerHTML = `
                    <div class="question-title">${q.question_title || q.q_id}</div>
                    <div class="question-text">${q.question_text}</div>
                    <div class="question-actions">
                        <select id="sel-${q.q_id}">
                            <option value="">Select...</option>
                            ${selectHtml}
                        </select>
                        <button class="btn btn-outline" onclick="submitAnswer('${q.q_id}')">Save</button>
                        <span id="status-${q.q_id}" class="status"></span>
                    </div>
                `;
                sectionBlock.appendChild(card);
            });
            container.appendChild(sectionBlock);
        });
    }

    function submitAnswer(qid) {
        if (!assessmentId) {
            document.getElementById("register-status").textContent = "Register an assessment ID first.";
            return;
        }
        const select = document.getElementById(`sel-${qid}`);
        if (!select || !select.value) return;
        const selected = select.options[select.selectedIndex];
        const score = parseFloat(selected.getAttribute("data-score") || "0");
        fetch(`${API_BASE}/dwf/submit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                assessment_id: assessmentId,
                q_id: qid,
                a_id: select.value,
                score: score
            })
        }).then(() => {
            const status = document.getElementById(`status-${qid}`);
            if (status) status.textContent = "Saved";
        }).catch(() => {
            const status = document.getElementById(`status-${qid}`);
            if (status) status.textContent = "Failed";
        });
    }

    function runAnalysis() {
        if (!assessmentId) return;
        fetch(`${API_BASE}/dwf/assessment/${encodeURIComponent(assessmentId)}/analysis`)
            .then(r => r.json())
            .then(data => {
                const output = document.getElementById("analysis-output");
                output.textContent = JSON.stringify(data, null, 2);
            })
            .catch(() => {
                const output = document.getElementById("analysis-output");
                output.textContent = "Failed to load analysis.";
            });
    }

    (function init() {
        const hashAid = getAidFromHash();
        const savedAid = localStorage.getItem("assessment_id") || "";
        assessmentId = hashAid || savedAid;
        if (assessmentId) {
            document.getElementById("aid-input").value = assessmentId;
            document.getElementById("register-status").textContent = `Active assessment: ${assessmentId}`;
            setAidHash(assessmentId);
            registerAssessment();
        }
    })();
</script>
<script>
    (function highlightSidebar() {
        const links = document.querySelectorAll('.left-nav a.side-btn');
        const current = location.pathname.split('/').pop() + (location.hash || "");
        links.forEach(link => {
            link.classList.remove('active');
            const href = link.getAttribute('href') || "";
            if (href === current || (!location.hash && href.endsWith('dynamic_workforce.html'))) {
                link.classList.add('active');
            }
        });
        try {
            localStorage.setItem('irmmf_sidebar_last', current);
        } catch (e) {}
    })();
</script>
</body>
</html>
